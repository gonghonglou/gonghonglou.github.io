<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="ç½‘ä¸Šå…³äº fishhook çš„æºç è§£è¯»ã€åŸç†åˆ†æçš„æ–‡ç« å·²ç»å¾ˆå¤šäº†ã€‚è¿™ç¯‡æ–‡ç« ä»…æ˜¯è‡ªå·±å¯¹ fishhook çš„å­¦ä¹ æ€»ç»“ç¬”è®°ã€‚å…¶å®æ˜¯ä¹‹å‰çœ‹çš„ fishhookï¼Œä½†æ€»æ„Ÿè§‰ä¸å†™ä¸‹æ¥çš„è¯ï¼Œä¸€æ®µæ—¶é—´ä¸çœ‹ï¼Œæœ‰äº›çŸ¥è¯†ç‚¹å°±å¿˜äº†ï¼Œæ‰€ä»¥è¿˜æ˜¯å‡ºä¸€ç¯‡åšå®¢è®°å½•ä¸‹å§ã€‚ ä¸ºäº†å¼€å‘ä¸€ä¸ªå®Œæ•´çš„ç¨‹åºï¼Œå°†ç¨‹åºçš„å„åŠŸèƒ½åˆ†æˆå„æ¨¡å—ï¼Œæ¨¡å—å•ç‹¬å¼€å‘ï¼Œå¼€å‘å®Œæˆåå•ç‹¬ç¼–è¯‘ï¼Œè·å¾—æœ€ç»ˆçš„é™æ€äº§ç‰©ï¼ˆå¦‚ iOS é‡Œçš„é™æ€åº“ .aï¼‰ã€‚å½“æ‰€æœ‰æ¨¡å—å¼€å‘å®Œæˆä¹‹åï¼Œå°†">
<meta property="og:type" content="article">
<meta property="og:title" content="fishhook æºç ç¬”è®°">
<meta property="og:url" content="http://gonghonglou.com/2021/08/21/fishhook/index.html">
<meta property="og:site_name" content="ä¸ä½³æœŸçš„ä¸ªäººåšå®¢">
<meta property="og:description" content="ç½‘ä¸Šå…³äº fishhook çš„æºç è§£è¯»ã€åŸç†åˆ†æçš„æ–‡ç« å·²ç»å¾ˆå¤šäº†ã€‚è¿™ç¯‡æ–‡ç« ä»…æ˜¯è‡ªå·±å¯¹ fishhook çš„å­¦ä¹ æ€»ç»“ç¬”è®°ã€‚å…¶å®æ˜¯ä¹‹å‰çœ‹çš„ fishhookï¼Œä½†æ€»æ„Ÿè§‰ä¸å†™ä¸‹æ¥çš„è¯ï¼Œä¸€æ®µæ—¶é—´ä¸çœ‹ï¼Œæœ‰äº›çŸ¥è¯†ç‚¹å°±å¿˜äº†ï¼Œæ‰€ä»¥è¿˜æ˜¯å‡ºä¸€ç¯‡åšå®¢è®°å½•ä¸‹å§ã€‚ ä¸ºäº†å¼€å‘ä¸€ä¸ªå®Œæ•´çš„ç¨‹åºï¼Œå°†ç¨‹åºçš„å„åŠŸèƒ½åˆ†æˆå„æ¨¡å—ï¼Œæ¨¡å—å•ç‹¬å¼€å‘ï¼Œå¼€å‘å®Œæˆåå•ç‹¬ç¼–è¯‘ï¼Œè·å¾—æœ€ç»ˆçš„é™æ€äº§ç‰©ï¼ˆå¦‚ iOS é‡Œçš„é™æ€åº“ .aï¼‰ã€‚å½“æ‰€æœ‰æ¨¡å—å¼€å‘å®Œæˆä¹‹åï¼Œå°†">
<meta property="og:locale">
<meta property="og:image" content="http://image.gonghonglou.com/fishhook/__got.png">
<meta property="og:image" content="http://image.gonghonglou.com/fishhook/__la_symbol_ptr.png">
<meta property="og:image" content="http://image.gonghonglou.com/fishhook/dyld_stub_binder_1.png">
<meta property="og:image" content="http://image.gonghonglou.com/fishhook/dyld_stub_binder_2.png">
<meta property="og:image" content="http://image.gonghonglou.com/fishhook/dyld_stub_binder_3.png">
<meta property="og:image" content="http://image.gonghonglou.com/fishhook/dyld_stub_binder_4.png">
<meta property="og:image" content="http://image.gonghonglou.com/fishhook/dyld_stub_binder_5.png">
<meta property="og:image" content="http://image.gonghonglou.com/fishhook/dyld_stub_binder_6.png">
<meta property="og:image" content="http://image.gonghonglou.com/fishhook/dyld_stub_binder_7.png">
<meta property="og:image" content="http://image.gonghonglou.com/fishhook/dyld_stub_binder_8.png">
<meta property="og:image" content="http://image.gonghonglou.com/fishhook/hook_log_dis.png">
<meta property="og:image" content="http://image.gonghonglou.com/fishhook/hook_log_mylog.png">
<meta property="og:image" content="http://image.gonghonglou.com/fishhook/machoview_nslog.png">
<meta property="og:image" content="http://image.gonghonglou.com/fishhook/image_list.png">
<meta property="og:image" content="http://image.gonghonglou.com/fishhook/dis_nslog_before.png">
<meta property="og:image" content="http://image.gonghonglou.com/fishhook/dis_nslog_after.png">
<meta property="og:image" content="http://image.gonghonglou.com/fishhook/macho.JPG">
<meta property="og:image" content="http://image.gonghonglou.com/fishhook/machoview_macho.png">
<meta property="og:image" content="http://image.gonghonglou.com/fishhook/machoview_segment_command_64.png">
<meta property="og:image" content="http://image.gonghonglou.com/fishhook/machoview_section_64.png">
<meta property="og:image" content="http://image.gonghonglou.com/fishhook/machoview_nlist_64.png">
<meta property="og:image" content="https://camo.githubusercontent.com/c29a64a3786c3ce426e142ef4ae697ba79c0ab2f2161923e08a458b99928b145/687474703a2f2f692e696d6775722e636f6d2f4856587148437a2e706e67">
<meta property="og:image" content="http://image.gonghonglou.com/fishhook/machoview_fishhook1.png">
<meta property="og:image" content="http://image.gonghonglou.com/fishhook/machoview_fishhook2.png">
<meta property="og:image" content="http://image.gonghonglou.com/fishhook/machoview_fishhook3.png">
<meta property="og:image" content="http://image.gonghonglou.com/fishhook/machoview_fishhook4.png">
<meta property="og:image" content="http://image.gonghonglou.com/fishhook/machoview_fishhook5.png">
<meta property="article:published_time" content="2021-08-21T03:22:00.000Z">
<meta property="article:modified_time" content="2021-08-21T10:07:05.564Z">
<meta property="article:author" content="ä¸ä½³æœŸ">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://image.gonghonglou.com/fishhook/__got.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"hide","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'åšä¸»'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://gonghonglou.com/2021/08/21/fishhook/"/>





  <title>fishhook æºç ç¬”è®° | ä¸ä½³æœŸçš„ä¸ªäººåšå®¢</title>
  








<meta name="generator" content="Hexo 6.3.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ä¸ä½³æœŸçš„ä¸ªäººåšå®¢</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">ç™»ç™½è– å…®éª‹æœ›ï¼Œä¸ä½³æœŸå…®å¤•å¼ ã€‚</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            é¦–é¡µ
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            å½’æ¡£
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            åˆ†ç±»
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            å…³äº
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            æœç´¢
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="æœç´¢..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://gonghonglou.com/2021/08/21/fishhook/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ä¸ä½³æœŸçš„ä¸ªäººåšå®¢">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">fishhook æºç ç¬”è®°</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2021-08-21T11:22:00+08:00">
                2021-08-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>ç½‘ä¸Šå…³äº <a target="_blank" rel="noopener" href="https://github.com/facebook/fishhook">fishhook</a> çš„æºç è§£è¯»ã€åŸç†åˆ†æçš„æ–‡ç« å·²ç»å¾ˆå¤šäº†ã€‚è¿™ç¯‡æ–‡ç« ä»…æ˜¯è‡ªå·±å¯¹ fishhook çš„å­¦ä¹ æ€»ç»“ç¬”è®°ã€‚å…¶å®æ˜¯ä¹‹å‰çœ‹çš„ fishhookï¼Œä½†æ€»æ„Ÿè§‰ä¸å†™ä¸‹æ¥çš„è¯ï¼Œä¸€æ®µæ—¶é—´ä¸çœ‹ï¼Œæœ‰äº›çŸ¥è¯†ç‚¹å°±å¿˜äº†ï¼Œæ‰€ä»¥è¿˜æ˜¯å‡ºä¸€ç¯‡åšå®¢è®°å½•ä¸‹å§ã€‚</p>
<p>ä¸ºäº†å¼€å‘ä¸€ä¸ªå®Œæ•´çš„ç¨‹åºï¼Œå°†ç¨‹åºçš„å„åŠŸèƒ½åˆ†æˆå„æ¨¡å—ï¼Œæ¨¡å—å•ç‹¬å¼€å‘ï¼Œå¼€å‘å®Œæˆåå•ç‹¬ç¼–è¯‘ï¼Œè·å¾—æœ€ç»ˆçš„é™æ€äº§ç‰©ï¼ˆå¦‚ iOS é‡Œçš„é™æ€åº“ .aï¼‰ã€‚å½“æ‰€æœ‰æ¨¡å—å¼€å‘å®Œæˆä¹‹åï¼Œå°†æ‰€æœ‰çš„é™æ€äº§ç‰©æ–‡ä»¶æ”¾åœ¨ä¸€èµ·è¿›è¡Œé“¾æ¥ï¼Œæ‰€æœ‰çš„æ–‡ä»¶æ‰“åŒ…åˆ°æœ€ç»ˆçš„å¯æ‰§è¡Œæ–‡ä»¶ä¸­ï¼Œå³å¯è¿è¡Œèµ·æœ€ç»ˆçš„ç¨‹åºã€‚è¿™å°±æ˜¯<strong>é™æ€é“¾æ¥</strong>ã€‚</p>
<p>é™æ€é“¾æ¥è§£å†³äº†ä»£ç å¤ç”¨ã€ååŒå·¥ä½œç­‰é—®é¢˜ã€‚ä½†å› ä¸ºæ‰€æœ‰çš„é™æ€äº§ç‰©ä¼šåœ¨é“¾æ¥è¿‡ç¨‹ä¸­æ‰“åŒ…è¿›æœ€ç»ˆçš„å¯æ‰§è¡Œæ–‡ä»¶ä¸­ï¼Œè¿™å°±å¯¼è‡´æœ€ç»ˆçš„å¯æ‰§è¡Œæ–‡ä»¶ä¼šæ¯”è¾ƒå¤§ã€‚è€Œä¸”å¦‚æœæŸä¸ªæ¨¡å—å‡ºç° bug æˆ–æ”¹åŠ¨ï¼Œå°±éœ€è¦è¯¥æ¨¡å—é‡æ–°ç¼–è¯‘ï¼Œæ•´ä¸ªç¨‹åºé‡æ–°é“¾æ¥ã€é‡æ–°ä¸‹è½½å®‰è£…æ‰èƒ½ç”Ÿæ•ˆã€‚ä¸ºäº†è§£å†³è¿™æ ·çš„é—®é¢˜ï¼Œå‡ºç°äº†<strong>åŠ¨æ€é“¾æ¥</strong>ã€‚åƒ UIKitã€Foundation ç­‰ç³»ç»Ÿåº“ï¼Œä¸ºäº†æ‰€æœ‰ App å¯ä»¥å¤ç”¨åŒä¸€ä»½ä»£ç ã€èŠ‚çœå­˜å‚¨ç©ºé—´ã€å³æ—¶æ›´æ–°ï¼Œå¯åœ¨ç¨‹åºè¿è¡ŒæœŸé—´è¿›è¡ŒåŠ è½½åŠ¨æ€åº“ï¼Œéœ€è¦ç”¨åˆ°çš„åŠ¨æ€åº“ç¬¦å·ï¼Œåœ¨è¿è¡ŒæœŸè¿›è¡Œå¯»å€ã€ç»‘å®šã€‚</p>
<p>fishhook çš„å·¥ä½œåŸç†æ­£æ˜¯ç¨‹åºè¿è¡ŒæœŸæ›´æ”¹ç¬¦å·çš„åœ°å€ï¼Œä»¥å®ç°æ–¹æ³• hookã€‚æ¯”å¦‚åŠ¨æ€åº“æ–¹æ³• NSLogï¼Œç³»ç»Ÿåœ¨ç¨‹åºè¿è¡ŒæœŸåŠ è½½åŠ¨æ€åº“ï¼Œå¯»æ‰¾ NSLog çš„ç¬¦å·åœ°å€è¿›è¡Œç»‘å®šä¸º 0x00000001ï¼Œè¯¥åœ°å€å‡½æ•°åŠŸèƒ½ä¸ºè¾“å‡ºæ‰“å°å†…å®¹åˆ°æ§åˆ¶å°ã€‚fishhook çš„å·¥ä½œåˆ™æ˜¯æ‰¾åˆ° NSLog çš„ç¬¦å·åœ°å€å°†å…¶ç»‘å®šä¸ºè‡ªå·±æä¾›çš„å‡½æ•°åœ°å€ 0x00000002ï¼Œè¯¥åœ°å€å‡½æ•°åŠŸèƒ½ä¸ºæ‹¼æ¥è‡ªå®šä¹‰æ•°æ®è¾“å‡ºæ‰“å°å†…å®¹åˆ°æ§åˆ¶å°ã€‚å…·ä½“å®ç°åç»­è¯¦è§£ã€‚</p>
<h1 id="åŠ¨æ€åº“ç¬¦å·åœ°å€æŸ¥æ‰¾ä¸ç»‘å®š"><a href="#åŠ¨æ€åº“ç¬¦å·åœ°å€æŸ¥æ‰¾ä¸ç»‘å®š" class="headerlink" title="åŠ¨æ€åº“ç¬¦å·åœ°å€æŸ¥æ‰¾ä¸ç»‘å®š"></a>åŠ¨æ€åº“ç¬¦å·åœ°å€æŸ¥æ‰¾ä¸ç»‘å®š</h1><p>Mach-O ä¸­ <code>__DATA</code> æ®µæœ‰ä¸¤ä¸ª Section ä¸åŠ¨æ€ç¬¦å·ç»‘å®šæœ‰å…³ç³»</p>
<p><strong>éæ‡’åŠ è½½ç¬¦å·æŒ‡é’ˆè¡¨ï¼ˆNon-Lazy Symbol Pointersï¼Œ<code>__got</code>ï¼‰</strong>ï¼šå­˜å‚¨äº† non-lazily ç»‘å®šçš„ç¬¦å·ï¼Œè¿™äº›ç¬¦å·åœ¨ Mach-O åŠ è½½çš„æ—¶å€™ç»‘å®šå®Œæˆã€‚</p>
<p><strong>æ‡’åŠ è½½ç¬¦å·æŒ‡é’ˆè¡¨ï¼ˆLazy Symbol Pointersï¼Œ<code>__la_symbol_ptr</code>ï¼‰</strong>ï¼šå­˜å‚¨äº† lazy ç»‘å®šçš„æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•åœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶ï¼Œç”± <code>dyld_stub_binder</code> è¿›è¡Œç»‘å®šã€‚</p>
<p>ç¬¬ä¸€æ¬¡è®¿é—® NSLog ç¬¦å·çš„æ—¶å€™å…ˆå» stubï¼Œstub å‘Šè¯‰ä» <code>__la_symbol_ptr</code> æŸ¥æ‰¾ï¼Œ<code>__la_symbol_ptr</code> è¡¨ç¤ºè¿˜æ²¡æœ‰ NSLog ç¬¦å·çœŸå®å‡½æ•°åœ°å€ï¼Œéœ€è¦åŠ¨æ€ç»‘å®šï¼Œäºæ˜¯å» <code>__got</code> æŸ¥æ‰¾ <code>dyld_stub_binder</code> å‡½æ•°çš„åœ°å€ï¼Œè¿›è¡ŒæŸ¥æ‰¾çœŸå®çš„ NSLog åœ°å€ã€‚æ‰¾åˆ°åè°ƒç”¨ NSLog å‡½æ•°ï¼Œå¹¶æŠŠè¿™ä¸ªåœ°å€ä¿å­˜è¿› <code>__la_symbol_ptr</code>ã€‚ä¸‹æ¬¡è°ƒç”¨ NSLogã€€å‡½æ•°çš„æ—¶å€™åœ¨ <code>__la_symbol_ptr</code> å°±èƒ½å¾—åˆ°çœŸå®åœ°å€è¿›è¡Œè·³è½¬ã€‚</p>
<p>é€šè¿‡ MachOView å¯ä»¥æŸ¥çœ‹è¿™ä¸¤ä¸ªè¡¨ï¼š</p>
<p><img src="http://image.gonghonglou.com/fishhook/__got.png"><br><img src="http://image.gonghonglou.com/fishhook/__la_symbol_ptr.png"></p>
<p>ä¸ºäº†æ›´ç›´è§‚çš„äº†è§£åŠ¨æ€åº“ç¬¦å·åœ°å€çš„æŸ¥æ‰¾ä¸ç»‘å®šè¿‡ç¨‹ï¼Œæ¥ä¸‹æ¥é€šè¿‡æ–­ç‚¹ç³»ç»Ÿå‡½æ•°ä¸€æ­¥æ­¥è·Ÿè¸ª NSLog ç¬¦å·æ‰§è¡Œè¿‡ç¨‹ï¼Œä¸»è¦æ˜¯ä¸ºäº†éªŒè¯æ‡’åŠ è½½ç¬¦å·çš„æŸ¥æ‰¾è¿‡ç¨‹ã€‚</p>
<p>æ–°å»ºä¸€ä¸ªç©ºå·¥ç¨‹ï¼Œåœ¨ VC çš„ viewDidLoad æ–¹æ³•é‡Œå†™ä¸Šä¸¤è¡Œ NSLog çš„è°ƒç”¨ä»£ç ï¼Œå¹¶åˆ†åˆ«æ‰“ä¸Šæ–­ç‚¹ã€‚æ³¨æ„ä¿è¯è¿™é‡Œç¬¬ä¸€è¡Œçš„ NSLog å‡½æ•°æ˜¯åœ¨å½“å‰å·¥ç¨‹è¿è¡Œåç¬¬ä¸€æ¬¡è¢«è°ƒç”¨ã€‚</p>
<p>è¿è¡Œåç¨‹åºä¼šæ–­ç‚¹åˆ°ç¬¬ä¸€è¡Œ NSLog ä»£ç ï¼Œæ­¤æ—¶é€šè¿‡ lldb çš„ <code>dis</code> å‘½ä»¤è¿›è¡Œåæ±‡ç¼–å½“å‰å‡½æ•°ï¼Œå¾—åˆ°çš„ç»“æœå¦‚ä¸‹ï¼š</p>
<p><img src="http://image.gonghonglou.com/fishhook/dyld_stub_binder_1.png"></p>
<p><code>bl</code> æ˜¯æ±‡ç¼–çš„è·³è½¬æŒ‡ä»¤ï¼Œæ„å‘³ç€ä¸‹ä¸€æ­¥ç¨‹åºå°†è·³è½¬åˆ° <code>0x10452e0dc</code> è¿™ä¸ªåœ°å€ã€‚å¦‚ä¸Šå›¾ï¼Œç»™è¿™ä¸ªåœ°å€æ‰“ä¸ªæ–­ç‚¹ï¼Œè·³åˆ°ä¸‹ä¸€æ­¥æ‰§è¡Œï¼š</p>
<p><img src="http://image.gonghonglou.com/fishhook/dyld_stub_binder_2.png"></p>
<p><code>ldr</code> æ±‡ç¼–æŒ‡ä»¤ï¼Œx16 å¯„å­˜å™¨ + 0x5f98ï¼ˆå³ <code>0x000000010452e52c</code>ï¼‰ï¼Œé€šè¿‡ <code>br</code> å‘½ä»¤è·³è½¬åˆ° x16 å¯„å­˜å™¨æŒ‡å®šçš„åœ°å€å¤„ã€‚<strong>æ³¨æ„ï¼Œç°åœ¨è¿™é‡Œåªæœ‰ä¸€ä¸ªå‡½æ•°åœ°å€ï¼Œåœ¨ç¬¦å·æ‡’åŠ è½½å¹¶ç»‘å®šåœ°å€ä¹‹åï¼Œå†æ‰§è¡Œçš„æ—¶å€™è¿™é‡Œå°±èƒ½ç›´æ¥æ‰§è¡Œç›®æ ‡å‡½æ•°äº†ã€‚</strong>å¦‚ä¸Šå›¾ï¼Œç»™è¿™ä¸ªåœ°å€æ‰“ä¸ªæ–­ç‚¹ï¼Œè·³åˆ°ä¸‹ä¸€æ­¥æ‰§è¡Œï¼š</p>
<p><img src="http://image.gonghonglou.com/fishhook/dyld_stub_binder_3.png"></p>
<p><code>b</code> æ±‡ç¼–æŒ‡ä»¤ï¼Œç«‹å³è·³è½¬åˆ°ç›®æ ‡åœ°å€ <code>0x10452e508</code>ã€‚å¦‚ä¸Šå›¾ï¼Œç»™è¿™ä¸ªåœ°å€æ‰“ä¸ªæ–­ç‚¹ï¼Œè·³åˆ°ä¸‹ä¸€æ­¥æ‰§è¡Œï¼š</p>
<p><img src="http://image.gonghonglou.com/fishhook/dyld_stub_binder_4.png"></p>
<p><code>ldr</code> æ±‡ç¼–æŒ‡ä»¤ï¼Œx16 å¯„å­˜å™¨ + 0x5b30ï¼ˆå³ <code>0x0000000184ac9474</code>ï¼Œæ³¨æ„å›¾ä¸­æ ‡æ³¨ï¼Œè¿™ä¸ªåœ°å€çš„å‡½æ•°æ˜¯ <code>dyld_stub_binder</code>ï¼Œç”¨æ¥å¯»å€åŠ¨æ€åº“ç¬¦å·å¹¶è¿›è¡Œç»‘å®šçš„ã€‚ï¼‰é€šè¿‡ <code>br</code> å‘½ä»¤è·³è½¬åˆ° x16 å¯„å­˜å™¨æŒ‡å®šçš„åœ°å€å¤„ã€‚å¦‚ä¸Šå›¾ï¼Œç»™è¿™ä¸ªåœ°å€æ‰“ä¸ªæ–­ç‚¹ï¼Œè·³åˆ°ä¸‹ä¸€æ­¥æ‰§è¡Œï¼š</p>
<p><img src="http://image.gonghonglou.com/fishhook/dyld_stub_binder_5.png"></p>
<p>è¿™å°±è¿›å…¥äº† <code>dyld_stub_binder</code> å‡½æ•°ï¼Œå¯ä»¥çœ‹åˆ°è¿™ä¸ªå‡½æ•°é‡Œåˆå°†è·³è½¬åˆ° <code>0x184acb034</code> åœ°å€ï¼Œæ³¨é‡Šä¸º <code>_dyld_fast_stub_entry(void*, long)</code> å‡½æ•°ã€‚æ€»ä¹‹å°±æ˜¯æ‰§è¡Œäº†ä¸€ç³»åˆ—æ¡©å‡½æ•°ç”¨æ¥ç¬¦å·å¯»å€å¹¶è¿›è¡Œç¬¦å·ç»‘å®šã€‚</p>
<p>ç‚¹å‡»è¿›è¡Œä¸‹ä¸€æ­¥æ–­ç‚¹çš„æ—¶å€™ï¼Œåˆå›åˆ°äº†æˆ‘ä»¬è‡ªå·±çš„ç¨‹åºï¼Œåˆ°äº†ç¬¬äºŒè¡Œ NSLog ä»£ç ï¼Œå†æ¬¡é€šè¿‡ lldb çš„ <code>dis</code> å‘½ä»¤è¿›è¡Œåæ±‡ç¼–å½“å‰å‡½æ•°ï¼Œå¾—åˆ°çš„ç»“æœå¦‚ä¸‹ï¼š</p>
<p><img src="http://image.gonghonglou.com/fishhook/dyld_stub_binder_6.png"></p>
<p>å¦‚ä¸Šå›¾ï¼Œå‡½æ•°å°†é€šè¿‡ <code>bl</code> å‘½ä»¤è·³è½¬åˆ° <code>0x10452e0dc</code> å¤„ã€‚åŒæ ·çš„ï¼Œç»™è¿™ä¸ªåœ°å€æ‰“ä¸ªæ–­ç‚¹ï¼Œè·³åˆ°ä¸‹ä¸€æ­¥æ‰§è¡Œï¼š</p>
<p><img src="http://image.gonghonglou.com/fishhook/dyld_stub_binder_7.png"></p>
<p><code>ldr</code> æ±‡ç¼–æŒ‡ä»¤ï¼Œx16 å¯„å­˜å™¨ + 0x5f98ï¼ˆå³ <code>0x00000001861eaba8</code>ï¼‰ï¼Œ<br>é€šè¿‡ <code>br</code> å‘½ä»¤è·³è½¬åˆ° x16 å¯„å­˜å™¨æŒ‡å®šçš„åœ°å€å¤„ã€‚<strong>æ³¨æ„ï¼Œä»å›¾ä¸­å°±èƒ½çœ‹å‡ºè¿™é‡Œå·²ç»çŸ¥é“äº† NSLog çš„åœ°å€äº†ï¼Œä¸‹ä¸€æ­¥å°†ç›´æ¥æ‰§è¡Œ NSLog å‡½æ•°ã€‚</strong>å¦‚ä¸Šå›¾ï¼Œç»™è¿™ä¸ªåœ°å€æ‰“ä¸ªæ–­ç‚¹ï¼Œè·³åˆ°ä¸‹ä¸€æ­¥æ‰§è¡Œï¼š</p>
<p><img src="http://image.gonghonglou.com/fishhook/dyld_stub_binder_8.png"></p>
<p>è¿™é‡Œå°±ç›´æ¥è¿›å…¥äº† NSLog å‡½æ•°ï¼Œæ²¡æœ‰é‚£äº› <code>dyld_stub_binder</code> å‡½æ•°çš„å¯»å€è¿‡ç¨‹äº†ã€‚</p>
<p>é€šè¿‡ä»¥ä¸Šæ–­ç‚¹è¿‡ç¨‹ï¼Œèƒ½å¤ŸéªŒè¯åŠ¨æ€åº“ç¬¦å·çš„æ‡’åŠ è½½è¿‡ç¨‹ã€‚</p>
<h1 id="fishhook-ä½¿ç”¨åŠéªŒè¯"><a href="#fishhook-ä½¿ç”¨åŠéªŒè¯" class="headerlink" title="fishhook ä½¿ç”¨åŠéªŒè¯"></a>fishhook ä½¿ç”¨åŠéªŒè¯</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">void</span>)fishhook_nslog &#123;</span><br><span class="line">    NSLog(@<span class="string">&quot;fishhook before&quot;</span>); <span class="comment">// fishhook before</span></span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rebinding</span> <span class="title">rebindingLog</span>;</span></span><br><span class="line">    <span class="comment">// éœ€è¦ hook çš„æ–¹æ³•å</span></span><br><span class="line">    rebindingLog.name = <span class="string">&quot;NSLog&quot;</span>;</span><br><span class="line">    <span class="comment">// æ›¿æ¢å‡½æ•°</span></span><br><span class="line">    rebindingLog.replacement = myLog;</span><br><span class="line">    <span class="comment">// ä¿å­˜åŸæœ¬å‡½æ•°æŒ‡é’ˆ</span></span><br><span class="line">    rebindingLog.replaced = (<span class="type">void</span> **)&amp;sys_nslog;</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rebinding</span> <span class="title">rebindings</span>[] =</span> &#123;rebindingLog&#125;;</span><br><span class="line">    </span><br><span class="line">    rebind_symbols(rebindings, <span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">    NSLog(@<span class="string">&quot;fishhook after&quot;</span>); <span class="comment">// fishhook after----&gt;ğŸºğŸºğŸº</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å‡½æ•°æŒ‡é’ˆï¼Œç”¨æ¥ä¿å­˜åŸæ¥çš„å‡½æ•°</span></span><br><span class="line"><span class="type">static</span> <span class="title function_">void</span> <span class="params">(*sys_nslog)</span><span class="params">(NSString *format, ...)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ›¿æ¢å‡½æ•°ï¼ˆæ³¨æ„ï¼šä¸å®šå‚æ•°æœªå¤„ç†ï¼‰</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">myLog</span><span class="params">(NSString * _Nonnull format, ...)</span> &#123;</span><br><span class="line">    NSString *message = [format stringByAppendingString:@<span class="string">&quot;----&gt;ğŸºğŸºğŸº&quot;</span>];</span><br><span class="line">    (*sys_nslog)(message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨ä¸Šä¸€ç« èŠ‚æ–­ç‚¹çš„æ–¹å¼éªŒè¯ hook ä¹‹åçš„ç»“æœã€‚åœ¨ä¸Šä¸€ç« èŠ‚çš„æ–­ç‚¹è¿‡ç¨‹ä¸­å·²ç»çŸ¥é“äº† NSLog åœ¨ç¬¬ä¸€æ¬¡è¢«è°ƒç”¨é€šè¿‡ <code>dyld_stub_binder</code> å‡½æ•°å¯»æ‰¾ç¬¦å·åœ°å€å¹¶ç»‘å®šä¹‹åï¼Œå†æ¬¡è¢«è°ƒç”¨çš„æ—¶å€™å·²ç»èƒ½å¤ŸçŸ¥é“ NSLog çš„ç¬¦å·åœ°å€äº†ã€‚è¿™é‡Œæˆ‘ä»¬åœ¨ hook ä»£ç ä¹‹ååçš„ NSLog è°ƒç”¨æ—¶æ‰“æ–­ç‚¹çœ‹çœ‹ç»“æœå¦‚ä½•ï¼š</p>
<p><img src="http://image.gonghonglou.com/fishhook/hook_log_dis.png"><br><img src="http://image.gonghonglou.com/fishhook/hook_log_mylog.png"></p>
<p>èƒ½å¤Ÿçœ‹åˆ°ï¼Œæ‰§è¡Œ NSLog æ—¶å°†ä¼šè·³è½¬åˆ° <code>(void *)0x0000000100a07ca8: myLog at /Users/gonghonglou/Desktop/HookDemo/Example/HookDemo/HKViewController.m:156</code>ã€‚ç»™ <code>0x0000000100a07ca8</code> åœ°å€æ‰“ä¸Šæ–­ç‚¹ï¼Œç‚¹å‡»æ‰§è¡Œä¸‹ä¸€æ­¥ç¨‹åºå°†ä¼šè·³è½¬åˆ°æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„ <code>myLog</code> å‡½æ•°å†…ï¼Œå³ <code>HKViewController.m:156</code> å¤„ã€‚</p>
<h2 id="é…åˆ-MachoView-éªŒè¯"><a href="#é…åˆ-MachoView-éªŒè¯" class="headerlink" title="é…åˆ MachoView éªŒè¯"></a>é…åˆ MachoView éªŒè¯</h2><p>å¦‚æœç”¨ MachoView æŸ¥çœ‹å½“å‰é¡¹ç›®çš„ Mach-O æ–‡ä»¶ï¼Œèƒ½å¤Ÿçœ‹åˆ° NSLog ç¬¦å·çš„åœ°å€åç§»é‡ï¼ŒåŠ ä¸Šç¨‹åºçš„èµ·å§‹åœ°å€å°±èƒ½å¾—åˆ° NSLog ç¬¦å·åœ°å€ï¼Œé€šè¿‡ dis å‘½ä»¤åæ±‡ç¼–ç›®æ ‡ç¬¦å·åœ°å€åŒæ ·èƒ½å¤ŸéªŒè¯ç¬¦å·æ›´æ”¹ç»‘å®šè¿‡ç¨‹ã€‚</p>
<p><img src="http://image.gonghonglou.com/fishhook/machoview_nslog.png"></p>
<p>é€šè¿‡ä¸Šå›¾èƒ½å¤Ÿçœ‹åˆ° NSLog çš„ offset æ˜¯ <code>0x3c078</code>ã€‚<br>æˆ‘ä»¬å·²ç»éªŒè¯äº† NSLog ç¬¦å·ç¬¬ä¸€æ¬¡è¢«è°ƒç”¨æ—¶ä¼šå» stub å‡½æ•°æŸ¥æ‰¾ç»‘å®šï¼Œè¿™é‡Œæˆ‘ä»¬å°±è·³è¿‡è¿™ä¸€è¿‡ç¨‹ï¼Œå°†æ–­ç‚¹æ‰“åœ¨ç¬¬äºŒæ¬¡è°ƒç”¨ NSLog ç¬¦å·çš„ä½ç½®ï¼š</p>
<p><img src="http://image.gonghonglou.com/fishhook/image_list.png"><br><img src="http://image.gonghonglou.com/fishhook/dis_nslog_before.png"></p>
<p>é€šè¿‡ <code>image list</code> æ‰“å°æ‰€æœ‰ image çš„åœ°å€ï¼Œä¸»å·¥ç¨‹çš„èµ·å§‹åœ°å€ä¸ºï¼š<code>0x0000000100a18000</code>ï¼Œé€šè¿‡ <code>x</code> å‘½ä»¤è·å–è¯¥åœ°å€åŠ ä¸Š offset çš„åœ°å€å†…å®¹ï¼ŒiOS é‡Œä¸ºå°ç«¯æ¨¡å¼ï¼Œä»åå¾€å‰è¯»è¯¥åœ°å€å­˜å‚¨çš„å†…å®¹ä¸ºï¼š<code>0x01861eaba8</code>ï¼Œé€šè¿‡ dis å‘½ä»¤åæ±‡ç¼–è¿™ä¸ªåœ°å€å³å¯çœ‹åˆ°å‡½æ•°å†…å®¹ä¸º NSLogã€‚</p>
<p>è·³è¿‡è¿™ä¸€æ–­ç‚¹ï¼Œfishhook é‡æ–°ç»‘å®šç¬¦å·ä¹‹åï¼Œæ–­ç‚¹è½åœ¨äº†ä¸‹å›¾ä½ç½®ï¼š</p>
<p><img src="http://image.gonghonglou.com/fishhook/dis_nslog_after.png"></p>
<p>é€šè¿‡ <code>x</code> å‘½ä»¤é‡æ–°è·å–ä¸»å·¥ç¨‹èµ·å§‹åœ°å€åŠ ä¸Š offset çš„åœ°å€å†…å®¹ä¸ºï¼š<code>0x0100a2bcb4</code>ï¼Œå†æ¬¡é€šè¿‡ dis å‘½ä»¤åæ±‡ç¼–è¿™ä¸ªåœ°å€å³å¯çœ‹åˆ°å‡½æ•°å†…å®¹æ”¹ä¸ºäº† myLogã€‚</p>
<h1 id="Mach-O-æ ¼å¼æ–‡ä»¶"><a href="#Mach-O-æ ¼å¼æ–‡ä»¶" class="headerlink" title="Mach-O æ ¼å¼æ–‡ä»¶"></a>Mach-O æ ¼å¼æ–‡ä»¶</h1><p>æ¥ä¸‹æ¥ä¸ºäº†æ¸…æ¥š fishhook å·¥ä½œçš„å…·ä½“åŸç†ï¼Œé¦–å…ˆè¦å‡†å¤‡çš„åŸºç¡€çŸ¥è¯†å°±æ˜¯ Mach-O æ ¼å¼æ–‡ä»¶ã€‚</p>
<p>Mach-Oï¼ˆMach Object File Formatï¼‰æè¿°äº† macOS ç³»ç»Ÿä¸Šå¯æ‰§è¡Œæ–‡ä»¶çš„æ ¼å¼ã€‚ä¸€ä¸ªå…¸å‹çš„ Mach-O æ–‡ä»¶æ ¼å¼å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="http://image.gonghonglou.com/fishhook/macho.JPG"></p>
<p>æˆ–é€šè¿‡ MachOView å·¥å…·æ›´ç›´è§‚çš„æŸ¥çœ‹ï¼Œå¦‚ä¸‹å›¾ï¼š</p>
<p><img src="http://image.gonghonglou.com/fishhook/machoview_macho.png"></p>
<p>å¯åœ¨ <code>mach-o/loader.h</code> æ–‡ä»¶å†…æ‰¾åˆ° Mach-O ç›¸å…³çš„ç»“æ„ä½“ï¼Œæ¥ä¸‹æ¥å¤§æ¦‚äº†è§£ä¸€äº›ç»“æ„ä½“ã€‚ï¼ˆè¯¥æ–‡ä»¶å†…çš„ç»“æ„ä½“åŒ…å« <code>x86</code> å’Œ <code>arm64</code> ä¸¤ç§ï¼Œä¸ºèŠ‚çº¦ç¯‡å¹…ï¼Œè¿™é‡Œå°±åªç¤ºä¾‹ <code>arm64</code> ç»“æ„äº†ï¼‰</p>
<p>ä» Mach-O æ–‡ä»¶æ ¼å¼å›¾é‡Œèƒ½å¤Ÿçœ‹å‡ºï¼ŒMach-O æ–‡ä»¶ä¸»è¦åŒ…å«ä»¥ä¸‹ä¸‰ä¸ªéƒ¨åˆ†ï¼š</p>
<p>1ã€Headerï¼šè®°å½•äº† cpu æ¶æ„ã€æ–‡ä»¶ç±»å‹èƒ½ä¿¡æ¯ã€‚<br>2ã€Load commandsï¼šåŒ…å«äº†å¾ˆå¤šä¸ª Segment command åŠ è½½å‘½ä»¤ï¼Œå­˜å‚¨äº† Mach-O çš„å¸ƒå±€ä¿¡æ¯ã€‚<br>3ã€Dataï¼šåŒ…å«äº†å¾ˆå¤šä¸ª Segmentï¼Œæ¯ä¸ª Segmengt åˆåŒ…å«äº†å¾ˆå¤šçš„ sectionï¼Œè®°å½•äº†å…·ä½“çš„ä»£ç æ•°æ®ã€‚</p>
<h2 id="mach-header-64"><a href="#mach-header-64" class="headerlink" title="mach_header_64"></a>mach_header_64</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The 64-bit mach header appears at the very beginning of object files for</span></span><br><span class="line"><span class="comment"> * 64-bit architectures.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mach_header_64</span> &#123;</span></span><br><span class="line">	<span class="type">uint32_t</span>	magic;		<span class="comment">/* mach magic number identifier */</span></span><br><span class="line">	<span class="type">cpu_type_t</span>	cputype;	<span class="comment">/* cpu specifier */</span></span><br><span class="line">	<span class="type">cpu_subtype_t</span>	cpusubtype;	<span class="comment">/* machine specifier */</span></span><br><span class="line">	<span class="type">uint32_t</span>	filetype;	<span class="comment">/* type of file */</span></span><br><span class="line">	<span class="type">uint32_t</span>	ncmds;		<span class="comment">/* number of load commands */</span></span><br><span class="line">	<span class="type">uint32_t</span>	sizeofcmds;	<span class="comment">/* the size of all the load commands */</span></span><br><span class="line">	<span class="type">uint32_t</span>	flags;		<span class="comment">/* flags */</span></span><br><span class="line">	<span class="type">uint32_t</span>	reserved;	<span class="comment">/* reserved */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>ä¸Šè¾¹å›¾ç‰‡é‡Œæ°å¥½èƒ½çœ‹åˆ° Mach64 Header ç»“æ„å†…å®¹ã€‚<br><strong>magic</strong>ï¼šé­”æ•°ï¼Œå†…å®¹æœ‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Constant for the magic field of the mach_header_64 (64-bit architectures) */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MH_MAGIC_64 0xfeedfacf <span class="comment">/* the 64-bit mach magic number */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MH_CIGAM_64 0xcffaedfe <span class="comment">/* NXSwapInt(MH_MAGIC_64) */</span></span></span><br></pre></td></tr></table></figure>

<p><strong>cputype</strong>ï¼šcpu ç±»å‹ï¼Œå†…å®¹æœ‰ CPU_TYPE_ARMã€CPU_TYPE_ARM64 ç­‰ã€‚<br><strong>filetype</strong>ï¼šæ–‡ä»¶ç±»å‹ï¼Œå†…å®¹æœ‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span>	MH_OBJECT	0x1		<span class="comment">/* relocatable object file */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	MH_EXECUTE	0x2		<span class="comment">/* demand paged executable file */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	MH_DYLIB	0x6		<span class="comment">/* dynamically bound shared library */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	MH_DYLINKER	0x7		<span class="comment">/* dynamic link editor */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	MH_DSYM		0xa		<span class="comment">/* companion file with only debug</span></span></span><br><span class="line"><span class="comment"><span class="meta">					   sections */</span></span></span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p><strong>ncmds</strong>ï¼šload command æ•°é‡ã€‚<br><strong>sizeofcmds</strong>ï¼šæ‰€æœ‰ load command å¤§å°ã€‚<br><strong>flags</strong>ï¼šæ–‡ä»¶æ ‡è®°ï¼Œå†…å®¹æœ‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Constants for the flags field of the mach_header */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	MH_NOUNDEFS	0x1		<span class="comment">/* the object file has no undefined</span></span></span><br><span class="line"><span class="comment"><span class="meta">					   references */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	MH_INCRLINK	0x2		<span class="comment">/* the object file is the output of an</span></span></span><br><span class="line"><span class="comment"><span class="meta">					   incremental link against a base file</span></span></span><br><span class="line"><span class="comment"><span class="meta">					   and can&#x27;t be link edited again */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MH_DYLDLINK	0x4		<span class="comment">/* the object file is input for the</span></span></span><br><span class="line"><span class="comment"><span class="meta">					   dynamic linker and can&#x27;t be staticly</span></span></span><br><span class="line"><span class="comment"><span class="meta">					   link edited again */</span></span></span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<h2 id="load-command"><a href="#load-command" class="headerlink" title="load_command"></a>load_command</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">load_command</span> &#123;</span></span><br><span class="line">	<span class="type">uint32_t</span> cmd;		<span class="comment">/* type of load command */</span></span><br><span class="line">	<span class="type">uint32_t</span> cmdsize;	<span class="comment">/* total size of command in bytes */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>cmd</strong>ï¼šload command çš„ç±»å‹ï¼Œå†…å®¹æœ‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Constants for the cmd field of all load commands, the type */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LC_SEGMENT	0x1	<span class="comment">/* segment of this file to be mapped */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LC_SYMTAB	0x2	<span class="comment">/* link-edit stab symbol table info */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LC_SYMSEG	0x3	<span class="comment">/* link-edit gdb symbol table info (obsolete) */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LC_THREAD	0x4	<span class="comment">/* thread */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LC_UNIXTHREAD	0x5	<span class="comment">/* unix thread (includes a stack) */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LC_LOADFVMLIB	0x6	<span class="comment">/* load a specified fixed VM shared library */</span></span></span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p><strong>cmdsize</strong>ï¼šload command æ€»è®¡å¤§å°ã€‚</p>
<h2 id="segment-command-64"><a href="#segment-command-64" class="headerlink" title="segment_command_64"></a>segment_command_64</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The 64-bit segment load command indicates that a part of this file is to be</span></span><br><span class="line"><span class="comment"> * mapped into a 64-bit task&#x27;s address space.  If the 64-bit segment has</span></span><br><span class="line"><span class="comment"> * sections then section_64 structures directly follow the 64-bit segment</span></span><br><span class="line"><span class="comment"> * command and their size is reflected in cmdsize.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">segment_command_64</span> &#123;</span> <span class="comment">/* for 64-bit architectures */</span></span><br><span class="line">	<span class="type">uint32_t</span>	cmd;		<span class="comment">/* LC_SEGMENT_64 */</span></span><br><span class="line">	<span class="type">uint32_t</span>	cmdsize;	<span class="comment">/* includes sizeof section_64 structs */</span></span><br><span class="line">	<span class="type">char</span>		segname[<span class="number">16</span>];	<span class="comment">/* segment name */</span></span><br><span class="line">	<span class="type">uint64_t</span>	vmaddr;		<span class="comment">/* memory address of this segment */</span></span><br><span class="line">	<span class="type">uint64_t</span>	vmsize;		<span class="comment">/* memory size of this segment */</span></span><br><span class="line">	<span class="type">uint64_t</span>	fileoff;	<span class="comment">/* file offset of this segment */</span></span><br><span class="line">	<span class="type">uint64_t</span>	filesize;	<span class="comment">/* amount to map from the file */</span></span><br><span class="line">	<span class="type">vm_prot_t</span>	maxprot;	<span class="comment">/* maximum VM protection */</span></span><br><span class="line">	<span class="type">vm_prot_t</span>	initprot;	<span class="comment">/* initial VM protection */</span></span><br><span class="line">	<span class="type">uint32_t</span>	nsects;		<span class="comment">/* number of sections in segment */</span></span><br><span class="line">	<span class="type">uint32_t</span>	flags;		<span class="comment">/* flags */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><img src="http://image.gonghonglou.com/fishhook/machoview_segment_command_64.png"></p>
<h2 id="section-64"><a href="#section-64" class="headerlink" title="section_64"></a>section_64</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * A segment is made up of zero or more sections.  Non-MH_OBJECT files have</span></span><br><span class="line"><span class="comment"> * all of their segments with the proper sections in each, and padded to the</span></span><br><span class="line"><span class="comment"> * specified segment alignment when produced by the link editor.  The first</span></span><br><span class="line"><span class="comment"> * segment of a MH_EXECUTE and MH_FVMLIB format file contains the mach_header</span></span><br><span class="line"><span class="comment"> * and load commands of the object file before its first section.  The zero</span></span><br><span class="line"><span class="comment"> * fill sections are always last in their segment (in all formats).  This</span></span><br><span class="line"><span class="comment"> * allows the zeroed segment padding to be mapped into memory where zero fill</span></span><br><span class="line"><span class="comment"> * sections might be. The gigabyte zero fill sections, those with the section</span></span><br><span class="line"><span class="comment"> * type S_GB_ZEROFILL, can only be in a segment with sections of this type.</span></span><br><span class="line"><span class="comment"> * These segments are then placed after all other segments.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The MH_OBJECT format has all of its sections in one segment for</span></span><br><span class="line"><span class="comment"> * compactness.  There is no padding to a specified segment boundary and the</span></span><br><span class="line"><span class="comment"> * mach_header and load commands are not part of the segment.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Sections with the same section name, sectname, going into the same segment,</span></span><br><span class="line"><span class="comment"> * segname, are combined by the link editor.  The resulting section is aligned</span></span><br><span class="line"><span class="comment"> * to the maximum alignment of the combined sections and is the new section&#x27;s</span></span><br><span class="line"><span class="comment"> * alignment.  The combined sections are aligned to their original alignment in</span></span><br><span class="line"><span class="comment"> * the combined section.  Any padded bytes to get the specified alignment are</span></span><br><span class="line"><span class="comment"> * zeroed.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The format of the relocation entries referenced by the reloff and nreloc</span></span><br><span class="line"><span class="comment"> * fields of the section structure for mach object files is described in the</span></span><br><span class="line"><span class="comment"> * header file &lt;reloc.h&gt;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">section_64</span> &#123;</span> <span class="comment">/* for 64-bit architectures */</span></span><br><span class="line">	<span class="type">char</span>		sectname[<span class="number">16</span>];	<span class="comment">/* name of this section */</span></span><br><span class="line">	<span class="type">char</span>		segname[<span class="number">16</span>];	<span class="comment">/* segment this section goes in */</span></span><br><span class="line">	<span class="type">uint64_t</span>	addr;		<span class="comment">/* memory address of this section */</span></span><br><span class="line">	<span class="type">uint64_t</span>	size;		<span class="comment">/* size in bytes of this section */</span></span><br><span class="line">	<span class="type">uint32_t</span>	offset;		<span class="comment">/* file offset of this section */</span></span><br><span class="line">	<span class="type">uint32_t</span>	align;		<span class="comment">/* section alignment (power of 2) */</span></span><br><span class="line">	<span class="type">uint32_t</span>	reloff;		<span class="comment">/* file offset of relocation entries */</span></span><br><span class="line">	<span class="type">uint32_t</span>	nreloc;		<span class="comment">/* number of relocation entries */</span></span><br><span class="line">	<span class="type">uint32_t</span>	flags;		<span class="comment">/* flags (section type and attributes)*/</span></span><br><span class="line">	<span class="type">uint32_t</span>	reserved1;	<span class="comment">/* reserved (for offset or index) */</span></span><br><span class="line">	<span class="type">uint32_t</span>	reserved2;	<span class="comment">/* reserved (for count or sizeof) */</span></span><br><span class="line">	<span class="type">uint32_t</span>	reserved3;	<span class="comment">/* reserved */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><img src="http://image.gonghonglou.com/fishhook/machoview_section_64.png"></p>
<h2 id="symtab-command"><a href="#symtab-command" class="headerlink" title="symtab_command"></a>symtab_command</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The symtab_command contains the offsets and sizes of the link-edit 4.3BSD</span></span><br><span class="line"><span class="comment"> * &quot;stab&quot; style symbol table information as described in the header files</span></span><br><span class="line"><span class="comment"> * &lt;nlist.h&gt; and &lt;stab.h&gt;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">symtab_command</span> &#123;</span></span><br><span class="line">	<span class="type">uint32_t</span>	cmd;		<span class="comment">/* LC_SYMTAB */</span></span><br><span class="line">	<span class="type">uint32_t</span>	cmdsize;	<span class="comment">/* sizeof(struct symtab_command) */</span></span><br><span class="line">	<span class="type">uint32_t</span>	symoff;		<span class="comment">/* symbol table offset */</span></span><br><span class="line">	<span class="type">uint32_t</span>	nsyms;		<span class="comment">/* number of symbol table entries */</span></span><br><span class="line">	<span class="type">uint32_t</span>	stroff;		<span class="comment">/* string table offset */</span></span><br><span class="line">	<span class="type">uint32_t</span>	strsize;	<span class="comment">/* string table size in bytes */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>æä¾›ç¬¦å·è¡¨ã€å­—ç¬¦ä¸²è¡¨ç›¸å¯¹äº Mach-O æ–‡ä»¶åœ¨ç£ç›˜ä¸­çš„æ–‡ä»¶åç§»</p>
<h2 id="dysymtab-command"><a href="#dysymtab-command" class="headerlink" title="dysymtab_command"></a>dysymtab_command</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dysymtab_command</span> &#123;</span></span><br><span class="line">    <span class="type">uint32_t</span> cmd;	<span class="comment">/* LC_DYSYMTAB */</span></span><br><span class="line">    <span class="type">uint32_t</span> cmdsize;	<span class="comment">/* sizeof(struct dysymtab_command) */</span></span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * The sections that contain &quot;symbol pointers&quot; and &quot;routine stubs&quot; have</span></span><br><span class="line"><span class="comment">     * indexes and (implied counts based on the size of the section and fixed</span></span><br><span class="line"><span class="comment">     * size of the entry) into the &quot;indirect symbol&quot; table for each pointer</span></span><br><span class="line"><span class="comment">     * and stub.  For every section of these two types the index into the</span></span><br><span class="line"><span class="comment">     * indirect symbol table is stored in the section header in the field</span></span><br><span class="line"><span class="comment">     * reserved1.  An indirect symbol table entry is simply a 32bit index into</span></span><br><span class="line"><span class="comment">     * the symbol table to the symbol that the pointer or stub is referring to.</span></span><br><span class="line"><span class="comment">     * The indirect symbol table is ordered to match the entries in the section.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">uint32_t</span> indirectsymoff; <span class="comment">/* file offset to the indirect symbol table */</span></span><br><span class="line">    <span class="type">uint32_t</span> nindirectsyms;  <span class="comment">/* number of indirect symbol table entries */</span></span><br><span class="line">    </span><br><span class="line">    ......    </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>æä¾›é—´æ¥ç¬¦å·è¡¨ç›¸å¯¹äº Mach-O æ–‡ä»¶åœ¨ç£ç›˜ä¸­çš„æ–‡ä»¶åç§»</p>
<h2 id="nlist-64"><a href="#nlist-64" class="headerlink" title="nlist_64"></a>nlist_64</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This is the symbol table entry structure for 64-bit architectures.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nlist_64</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        <span class="type">uint32_t</span>  n_strx; <span class="comment">/* index into the string table */</span></span><br><span class="line">    &#125; n_un;</span><br><span class="line">    <span class="type">uint8_t</span> n_type;        <span class="comment">/* type flag, see below */</span></span><br><span class="line">    <span class="type">uint8_t</span> n_sect;        <span class="comment">/* section number or NO_SECT */</span></span><br><span class="line">    <span class="type">uint16_t</span> n_desc;       <span class="comment">/* see &lt;mach-o/stab.h&gt; */</span></span><br><span class="line">    <span class="type">uint64_t</span> n_value;      <span class="comment">/* value of this symbol (or stab offset) */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><img src="http://image.gonghonglou.com/fishhook/machoview_nlist_64.png"></p>
<p>è¯¥ç»“æ„ä½“å­˜åœ¨äº <code>mach-o/nlist.h</code> æ–‡ä»¶ä¸­ã€‚è¡¨ç¤ºç¬¦å·è¡¨ <code>Symbol Table</code> ä¸­çš„ç»“æ„ä½“ã€‚</p>
<h1 id="fishhook-å®˜å›¾æµç¨‹"><a href="#fishhook-å®˜å›¾æµç¨‹" class="headerlink" title="fishhook å®˜å›¾æµç¨‹"></a>fishhook å®˜å›¾æµç¨‹</h1><blockquote>
<p><strong>How it works</strong><br>dyldÂ binds lazy and non-lazy symbols by updating pointers in particular sections of theÂ __DATAÂ segment of a Mach-O binary.Â fishhookÂ re-binds these symbols by determining the locations to update for each of the symbol names passed toÂ rebind_symbolsÂ and then writing out the corresponding replacements.<br>For a given image, theÂ __DATAÂ segment may contain two sections that are relevant for dynamic symbol bindings:Â __nl_symbol_ptrÂ andÂ __la_symbol_ptr.Â __nl_symbol_ptrÂ is an array of pointers to non-lazily bound data (these are bound at the time a library is loaded) andÂ __la_symbol_ptrÂ is an array of pointers to imported functions that is generally filled by a routine calledÂ dyld_stub_binderÂ during the first call to that symbol (itâ€™s also possible to tellÂ dyldÂ to bind these at launch). In order to find the name of the symbol that corresponds to a particular location in one of these sections, we have to jump through several layers of indirection. For the two relevant sections, the section headers (struct sections fromÂ &lt;mach-o&#x2F;loader.h&gt;) provide an offset (in theÂ reserved1Â field) into what is known as the indirect symbol table. The indirect symbol table, which is located in theÂ __LINKEDITÂ segment of the binary, is just an array of indexes into the symbol table (also inÂ __LINKEDIT) whose order is identical to that of the pointers in the non-lazy and lazy symbol sections. So, givenÂ struct section nl_symbol_ptr, the corresponding index in the symbol table of the first address in that section isÂ indirect_symbol_table[nl_symbol_ptr-&gt;reserved1]. The symbol table itself is an array ofÂ struct nlists (seeÂ &lt;mach-o&#x2F;nlist.h&gt;), and eachÂ nlistÂ contains an index into the string table inÂ __LINKEDITÂ which where the actual symbol names are stored. So, for each pointerÂ __nl_symbol_ptrÂ andÂ __la_symbol_ptr, we are able to find the corresponding symbol and then the corresponding string to compare against the requested symbol names, and if there is a match, we replace the pointer in the section with the replacement.<br>The process of looking up the name of a given entry in the lazy or non-lazy pointer tables looks like this:</p>
</blockquote>
<p><img src="https://camo.githubusercontent.com/c29a64a3786c3ce426e142ef4ae697ba79c0ab2f2161923e08a458b99928b145/687474703a2f2f692e696d6775722e636f6d2f4856587148437a2e706e67"></p>
<p>æˆ‘ä»¬ç»“åˆ MachOView èµ°ä¸€é fishhook çš„æµç¨‹å›¾ï¼ŒéªŒè¯ä¸€éè¿‡ç¨‹ã€‚</p>
<p>1ã€åœ¨ Lazy Symbol Pointers Table é‡Œæ‰¾åˆ° NSLogï¼Œå…¶æ‰€åœ¨è§’æ ‡ä¸º <code>5</code>ã€‚</p>
<p><img src="http://image.gonghonglou.com/fishhook/machoview_fishhook1.png"></p>
<p>2ã€åœ¨ Indirect Symbols Table é‡Œè§’æ ‡ <code>5</code> ä½ç½®å¤„æ‰¾åˆ° NSLogï¼ŒData ä¸º <code>0xA11</code>ã€‚</p>
<p><img src="http://image.gonghonglou.com/fishhook/machoview_fishhook2.png"></p>
<p>3ã€å°† Indirect Symbols Table é‡Œæ‰¾åˆ°çš„ NSlog çš„ Data å€¼è½¬ä¸ºåè¿›åˆ¶ï¼ˆ<code>0xA11 = 2577</code>ï¼‰ã€‚åœ¨ Symbols Table -&gt; Symbols è¡¨ä¸­è§’æ ‡ <code>2577</code> ä½ç½®å¤„æ‰¾åˆ° NSLogï¼ŒData ä¸º <code>0xBE4</code>ã€‚</p>
<p><img src="http://image.gonghonglou.com/fishhook/machoview_fishhook3.png"></p>
<p>4ã€åœ¨Â String Table é‡Œæ‰¾åˆ°èµ·å§‹ä½ç½®ä¸º <code>0x50BB8</code>ï¼ŒåŠ ä¸Š Indirect Symbols è¡¨é‡Œæ‰¾åˆ°çš„ NSlog çš„ Data å€¼ <code>0xBE4</code>ï¼Œå³ï¼š<code>0x50BB8 + 0xBE4 = 0x5179c</code>ã€‚åœ¨Â String Table é‡Œæ‰¾åˆ° <code>0x5179c</code> ä½ç½®ï¼Œæœç„¶æ‰¾åˆ° <code>_NSLog</code> å­—ç¬¦ã€‚</p>
<p><img src="http://image.gonghonglou.com/fishhook/machoview_fishhook4.png"><br><img src="http://image.gonghonglou.com/fishhook/machoview_fishhook5.png"></p>
<p>æ­¤æ—¶åŒ¹é…åˆ°ç›®æ ‡ç¬¦å·åå³å¯ä¿®æ”¹æ‡’åŠ è½½ç¬¦å·è¡¨é‡Œç›®æ ‡ä½ç½®å¤„ç»‘å®šçš„ç¬¦å·åœ°å€äº†ï¼Œå°†å…¶ä¿®æ”¹ä¸ºæˆ‘ä»¬è‡ªå®šä¹‰çš„ <code>myLog</code> å‡½æ•°åœ°å€å³å®Œæˆäº† hook æ“ä½œã€‚</p>
<h1 id="fishhook-æºç è§£è¯»"><a href="#fishhook-æºç è§£è¯»" class="headerlink" title="fishhook æºç è§£è¯»"></a>fishhook æºç è§£è¯»</h1><h2 id="struct-rebinding"><a href="#struct-rebinding" class="headerlink" title="struct rebinding"></a>struct rebinding</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rebinding</span> &#123;</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *name;     <span class="comment">// è¢« hook çš„ç›®æ ‡å‡½æ•°åç§°ï¼ˆæ—§å‡½æ•°åç§°ï¼‰</span></span><br><span class="line">  <span class="type">void</span> *replacement;    <span class="comment">// æ›¿æ¢å‡½æ•°åœ°å€ï¼ˆæ–°å‡½æ•°åœ°å€ï¼‰</span></span><br><span class="line">  <span class="type">void</span> **replaced;      <span class="comment">// è¢« hook çš„ç›®æ ‡å‡½æ•°åœ°å€çš„æŒ‡é’ˆï¼ˆæ—§å‡½æ•°åœ°å€çš„æŒ‡é’ˆï¼‰</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>åœ¨ fishhook.h é‡Œèƒ½å¤Ÿçœ‹åˆ°è¿™ä¸ª rebinding ç»“æ„ä½“ï¼Œç”¨æ¥å­˜å‚¨ hook ä¿¡æ¯ã€‚</p>
<h2 id="struct-rebindings-entry"><a href="#struct-rebindings-entry" class="headerlink" title="struct rebindings_entry"></a>struct rebindings_entry</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rebindings_entry</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">rebinding</span> *<span class="title">rebindings</span>;</span>     <span class="comment">// å°†è¦ hook çš„å‡½æ•°çš„ rebinding æ•°ç»„</span></span><br><span class="line">  <span class="type">size_t</span> rebindings_nel;            <span class="comment">// æ•°ç»„é•¿åº¦</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">rebindings_entry</span> *<span class="title">next</span>;</span>    <span class="comment">// ä¸‹ä¸ª entryï¼Œç±»ä¼¼é“¾è¡¨ç»“æ„</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">rebindings_entry</span> *_<span class="title">rebindings_head</span>;</span> <span class="comment">// rebindings_entry head å…¥å£</span></span><br></pre></td></tr></table></figure>

<p><code>_rebindings_head</code> é™æ€å˜é‡ï¼Œå­˜å‚¨ <code>rebindings_entry</code> å…¥å£<br>é€šè¿‡ <code>next</code> éå† <code>rebindings_entry</code> ç»“æ„ä½“<br>æ¯ä¸ª <code>rebindings_entry</code> ç»“æ„ä½“é‡Œé€šè¿‡ <code>rebindings_nel</code> éå†å°†è¦ hook çš„å‡½æ•°çš„ <code>rebindings</code> æ•°ç»„ã€‚</p>
<p>åœ¨åç»­çš„ <code>perform_rebinding_with_section</code> æ–¹æ³•é‡Œèƒ½å¤Ÿçœ‹åˆ°å…·ä½“çš„éå†è§„åˆ™</p>
<h2 id="rebind-symbols-image"><a href="#rebind-symbols-image" class="headerlink" title="rebind_symbols_image"></a>rebind_symbols_image</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">rebind_symbols_image</span><span class="params">(<span class="type">void</span> *header,</span></span><br><span class="line"><span class="params">                         <span class="type">intptr_t</span> slide,</span></span><br><span class="line"><span class="params">                         <span class="keyword">struct</span> rebinding rebindings[],</span></span><br><span class="line"><span class="params">                         <span class="type">size_t</span> rebindings_nel)</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rebindings_entry</span> *<span class="title">rebindings_head</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">int</span> retval = prepend_rebindings(&amp;rebindings_head, rebindings, rebindings_nel);</span><br><span class="line">    rebind_symbols_for_image(rebindings_head, header, slide);</span><br><span class="line">    <span class="built_in">free</span>(rebindings_head);</span><br><span class="line">    <span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æŒ‡å®š image è¿›è¡Œ hookï¼Œé€»è¾‘åŒ <code>rebind_symbols</code> æ–¹æ³•ï¼Œå…·ä½“åˆ†æçœ‹ <code>rebind_symbols</code> æ–¹æ³•ã€‚</p>
<h2 id="rebind-symbols"><a href="#rebind-symbols" class="headerlink" title="rebind_symbols"></a>rebind_symbols</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">rebind_symbols</span><span class="params">(<span class="keyword">struct</span> rebinding rebindings[], <span class="type">size_t</span> rebindings_nel)</span> &#123;</span><br><span class="line">  <span class="comment">// å°†ä¼ å…¥çš„ rebindings æ•°ç»„å­˜å‚¨åˆ°å…¨å±€çš„é“¾è¡¨ä¸­</span></span><br><span class="line">  <span class="type">int</span> retval = prepend_rebindings(&amp;_rebindings_head, rebindings, rebindings_nel);</span><br><span class="line">  <span class="comment">// å¼‚å¸¸ç›´æ¥è¿”å›</span></span><br><span class="line">  <span class="keyword">if</span> (retval &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> retval;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è°ƒç”¨ï¼Œæ³¨å†Œ image åŠ è½½å›è°ƒ</span></span><br><span class="line">  <span class="comment">// If this was the first call, register callback for image additions (which is also invoked for</span></span><br><span class="line">  <span class="comment">// existing images, otherwise, just run on existing images</span></span><br><span class="line">  <span class="keyword">if</span> (!_rebindings_head-&gt;next) &#123;</span><br><span class="line">    _dyld_register_func_for_add_image(_rebind_symbols_for_image);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// ä¸æ˜¯ç¬¬ä¸€æ¬¡è°ƒç”¨ï¼Œéå†æ‰€æœ‰çš„ image è¿›è¡Œ hook</span></span><br><span class="line">    <span class="type">uint32_t</span> c = _dyld_image_count();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">uint32_t</span> i = <span class="number">0</span>; i &lt; c; i++) &#123;</span><br><span class="line">      _rebind_symbols_for_image(_dyld_get_image_header(i), _dyld_get_image_vmaddr_slide(i));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="prepend-rebindings"><a href="#prepend-rebindings" class="headerlink" title="prepend_rebindings"></a>prepend_rebindings</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">prepend_rebindings</span><span class="params">(<span class="keyword">struct</span> rebindings_entry **rebindings_head,</span></span><br><span class="line"><span class="params">                              <span class="keyword">struct</span> rebinding rebindings[],</span></span><br><span class="line"><span class="params">                              <span class="type">size_t</span> nel)</span> &#123;</span><br><span class="line">  <span class="comment">// åˆ›å»ºä¸€ä¸ªæ–°çš„ rebindings_entry ç»“æ„ä½“</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">rebindings_entry</span> *<span class="title">new_entry</span> =</span> <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> rebindings_entry));</span><br><span class="line">  <span class="keyword">if</span> (!new_entry) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ç»™ rebindings å¼€è¾Ÿç©ºé—´ï¼Œå¤§å°å³ä¼ å…¥çš„ rebindings æ•°ç»„çš„å¤§å°</span></span><br><span class="line">  new_entry-&gt;rebindings = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> rebinding) * nel);</span><br><span class="line">  <span class="keyword">if</span> (!new_entry-&gt;rebindings) &#123;</span><br><span class="line">    <span class="built_in">free</span>(new_entry);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å°†ä¼ å…¥çš„ rebindings èµ‹å€¼ç»™ new_entry-&gt;rebindings</span></span><br><span class="line">  <span class="built_in">memcpy</span>(new_entry-&gt;rebindings, rebindings, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> rebinding) * nel);</span><br><span class="line">  <span class="comment">// å°†ä¼ å…¥çš„ rebindings çš„ é•¿åº¦èµ‹å€¼ç»™ new_entry-&gt;rebindings_nel</span></span><br><span class="line">  new_entry-&gt;rebindings_nel = nel;</span><br><span class="line">  <span class="comment">// å°†å…¨å±€å˜é‡ rebindings_head è®¾ç½®ä¸ºé“¾è¡¨çš„å¤´éƒ¨</span></span><br><span class="line">  new_entry-&gt;next = *rebindings_head;</span><br><span class="line">  *rebindings_head = new_entry;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="rebind-symbols-for-image"><a href="#rebind-symbols-for-image" class="headerlink" title="_rebind_symbols_for_image"></a>_rebind_symbols_for_image</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> _rebind_symbols_for_image(<span class="type">const</span> <span class="keyword">struct</span> mach_header *header,</span><br><span class="line">                                      <span class="type">intptr_t</span> slide) &#123;</span><br><span class="line">    rebind_symbols_for_image(_rebindings_head, header, slide);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¯¥æ–¹æ³•è¦ä¹ˆé€šè¿‡ <code>_dyld_register_func_for_add_image</code> æ³¨å†Œå›è°ƒè¢«è°ƒç”¨ï¼Œè¦ä¹ˆéå†æ‰€æœ‰çš„ image ä¸»åŠ¨è°ƒç”¨ï¼Œä¼ å…¥ <code>header</code> åŠ <code>slide</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="type">void</span> _dyld_register_func_for_add_image(<span class="type">void</span> (*func)(<span class="type">const</span> <span class="keyword">struct</span> mach_header* mh, <span class="type">intptr_t</span> vmaddr_slide))    __OSX_AVAILABLE_STARTING(__MAC_10_1, __IPHONE_2_0);</span><br></pre></td></tr></table></figure>

<h2 id="rebind-symbols-for-image-1"><a href="#rebind-symbols-for-image-1" class="headerlink" title="rebind_symbols_for_image"></a>rebind_symbols_for_image</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">rebind_symbols_for_image</span><span class="params">(<span class="keyword">struct</span> rebindings_entry *rebindings,</span></span><br><span class="line"><span class="params">                                     <span class="type">const</span> <span class="keyword">struct</span> mach_header *header,</span></span><br><span class="line"><span class="params">                                     <span class="type">intptr_t</span> slide)</span> &#123;</span><br><span class="line">  Dl_info info;</span><br><span class="line">  <span class="comment">// dladdr å‡½æ•°è·å– header åœ°å€çš„ç¬¦å·ä¿¡æ¯</span></span><br><span class="line">  <span class="keyword">if</span> (dladdr(header, &amp;info) == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">segment_command_t</span> *cur_seg_cmd;</span><br><span class="line">  <span class="type">segment_command_t</span> *linkedit_segment = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">symtab_command</span>* <span class="title">symtab_cmd</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">dysymtab_command</span>* <span class="title">dysymtab_cmd</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  <span class="type">uintptr_t</span> cur = (<span class="type">uintptr_t</span>)header + <span class="keyword">sizeof</span>(<span class="type">mach_header_t</span>);</span><br><span class="line">  <span class="comment">// éå† load commandsï¼Œå¯»æ‰¾ linkedit segmentã€symtab commandã€dysymtab command</span></span><br><span class="line">  <span class="keyword">for</span> (uint i = <span class="number">0</span>; i &lt; header-&gt;ncmds; i++, cur += cur_seg_cmd-&gt;cmdsize) &#123;</span><br><span class="line">    cur_seg_cmd = (<span class="type">segment_command_t</span> *)cur;</span><br><span class="line">    <span class="keyword">if</span> (cur_seg_cmd-&gt;cmd == LC_SEGMENT_ARCH_DEPENDENT) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">strcmp</span>(cur_seg_cmd-&gt;segname, SEG_LINKEDIT) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// cmd == LC_SEGMENT_64 &amp;&amp; segname == SEG_LINKEDIT æ—¶ï¼Œå³ä¸º linkedit segment</span></span><br><span class="line">        <span class="comment">// æ³¨ï¼š</span></span><br><span class="line">        <span class="comment">// #define    LC_SEGMENT_64    0x19    /* 64-bit segment of this file to be mapped */</span></span><br><span class="line">        <span class="comment">// #define    SEG_LINKEDIT    &quot;__LINKEDIT&quot;    /* the segment containing all structs */</span></span><br><span class="line">        linkedit_segment = cur_seg_cmd;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cur_seg_cmd-&gt;cmd == LC_SYMTAB) &#123;</span><br><span class="line">      <span class="comment">// cmd == LC_SYMTAB å³ä¸º symtab command</span></span><br><span class="line">      <span class="comment">// æ³¨ï¼š</span></span><br><span class="line">      <span class="comment">// #define    LC_SYMTAB    0x2    /* link-edit stab symbol table info */</span></span><br><span class="line">      symtab_cmd = (<span class="keyword">struct</span> symtab_command*)cur_seg_cmd;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cur_seg_cmd-&gt;cmd == LC_DYSYMTAB) &#123;</span><br><span class="line">      <span class="comment">// cmd == LC_DYSYMTAB å³ä¸º dysymtab command</span></span><br><span class="line">      <span class="comment">// æ³¨ï¼š</span></span><br><span class="line">      <span class="comment">// #define    LC_DYSYMTAB    0xb    /* dynamic link-edit symbol table info */</span></span><br><span class="line">      dysymtab_cmd = (<span class="keyword">struct</span> dysymtab_command*)cur_seg_cmd;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æœªæ‰¾åˆ°ç›®æ ‡ä¿¡æ¯ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">  <span class="keyword">if</span> (!symtab_cmd || !dysymtab_cmd || !linkedit_segment ||</span><br><span class="line">      !dysymtab_cmd-&gt;nindirectsyms) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æŸ¥æ‰¾ç¬¦å·è¡¨/å­—ç¬¦ä¸²è¡¨åœ°å€</span></span><br><span class="line">  <span class="comment">// Find base symbol/string table addresses</span></span><br><span class="line">  <span class="type">uintptr_t</span> linkedit_base = (<span class="type">uintptr_t</span>)slide + linkedit_segment-&gt;vmaddr - linkedit_segment-&gt;fileoff;</span><br><span class="line">  <span class="type">nlist_t</span> *symtab = (<span class="type">nlist_t</span> *)(linkedit_base + symtab_cmd-&gt;symoff);</span><br><span class="line">  <span class="type">char</span> *strtab = (<span class="type">char</span> *)(linkedit_base + symtab_cmd-&gt;stroff);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è·å–é—´æ¥ç¬¦å·è¡¨</span></span><br><span class="line">  <span class="comment">// Get indirect symbol table (array of uint32_t indices into symbol table)</span></span><br><span class="line">  <span class="type">uint32_t</span> *indirect_symtab = (<span class="type">uint32_t</span> *)(linkedit_base + dysymtab_cmd-&gt;indirectsymoff);</span><br><span class="line"></span><br><span class="line">  cur = (<span class="type">uintptr_t</span>)header + <span class="keyword">sizeof</span>(<span class="type">mach_header_t</span>);</span><br><span class="line">  <span class="comment">// éå† load commandsï¼Œå¯»æ‰¾æ‡’åŠ è½½ç¬¦å·è¡¨ï¼ˆS_LAZY_SYMBOL_POINTERSï¼‰ã€éæ‡’åŠ è½½ç¬¦å·è¡¨ï¼ˆS_NON_LAZY_SYMBOL_POINTERSï¼‰ï¼Œè¿›è¡Œæ›´æ”¹ç¬¦å·åœ°å€</span></span><br><span class="line">  <span class="keyword">for</span> (uint i = <span class="number">0</span>; i &lt; header-&gt;ncmds; i++, cur += cur_seg_cmd-&gt;cmdsize) &#123;</span><br><span class="line">    cur_seg_cmd = (<span class="type">segment_command_t</span> *)cur;</span><br><span class="line">    <span class="keyword">if</span> (cur_seg_cmd-&gt;cmd == LC_SEGMENT_ARCH_DEPENDENT) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">strcmp</span>(cur_seg_cmd-&gt;segname, SEG_DATA) != <span class="number">0</span> &amp;&amp;</span><br><span class="line">          <span class="built_in">strcmp</span>(cur_seg_cmd-&gt;segname, SEG_DATA_CONST) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">for</span> (uint j = <span class="number">0</span>; j &lt; cur_seg_cmd-&gt;nsects; j++) &#123;</span><br><span class="line">        <span class="type">section_t</span> *sect =</span><br><span class="line">          (<span class="type">section_t</span> *)(cur + <span class="keyword">sizeof</span>(<span class="type">segment_command_t</span>)) + j;</span><br><span class="line">        <span class="keyword">if</span> ((sect-&gt;flags &amp; SECTION_TYPE) == S_LAZY_SYMBOL_POINTERS) &#123;</span><br><span class="line">          <span class="comment">// æ³¨ï¼š</span></span><br><span class="line">          <span class="comment">// #define    S_LAZY_SYMBOL_POINTERS        0x7    /* section with only lazy symbol pointers */</span></span><br><span class="line">          perform_rebinding_with_section(rebindings, sect, slide, symtab, strtab, indirect_symtab);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((sect-&gt;flags &amp; SECTION_TYPE) == S_NON_LAZY_SYMBOL_POINTERS) &#123;</span><br><span class="line">          <span class="comment">// æ³¨ï¼š</span></span><br><span class="line">          <span class="comment">// #define    S_NON_LAZY_SYMBOL_POINTERS    0x6    /* section with only non-lazy symbol pointers */</span></span><br><span class="line">          perform_rebinding_with_section(rebindings, sect, slide, symtab, strtab, indirect_symtab);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="perform-rebinding-with-section"><a href="#perform-rebinding-with-section" class="headerlink" title="perform_rebinding_with_section"></a>perform_rebinding_with_section</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">perform_rebinding_with_section</span><span class="params">(<span class="keyword">struct</span> rebindings_entry *rebindings,</span></span><br><span class="line"><span class="params">                                           <span class="type">section_t</span> *section,</span></span><br><span class="line"><span class="params">                                           <span class="type">intptr_t</span> slide,</span></span><br><span class="line"><span class="params">                                           <span class="type">nlist_t</span> *symtab,</span></span><br><span class="line"><span class="params">                                           <span class="type">char</span> *strtab,</span></span><br><span class="line"><span class="params">                                           <span class="type">uint32_t</span> *indirect_symtab)</span> &#123;</span><br><span class="line">  <span class="comment">// æ ¹æ® section é‡Œè®°å½•çš„ reserved1 æŸ¥æ‰¾ Indirect Symbols</span></span><br><span class="line">  <span class="comment">// æ³¨ï¼š</span></span><br><span class="line">  <span class="comment">// uint32_t    reserved1;    /* reserved (for offset or index) */</span></span><br><span class="line">  <span class="type">uint32_t</span> *indirect_symbol_indices = indirect_symtab + section-&gt;reserved1;</span><br><span class="line">  <span class="comment">// æ ¹æ®éšæœºåç§»é‡ slide + section åœ°å€æ‰¾åˆ°ç¬¦å·æŒ‡é’ˆè¡¨ï¼Œä»¥ä¿®æ”¹å…¶ä¸­çš„ç¬¦å·ç»‘å®š</span></span><br><span class="line">  <span class="type">void</span> **indirect_symbol_bindings = (<span class="type">void</span> **)((<span class="type">uintptr_t</span>)slide + section-&gt;addr);</span><br><span class="line">  <span class="comment">// éå† sectionï¼ŒæŸ¥æ‰¾ç›®æ ‡ç¬¦å·</span></span><br><span class="line">  <span class="keyword">for</span> (uint i = <span class="number">0</span>; i &lt; section-&gt;size / <span class="keyword">sizeof</span>(<span class="type">void</span> *); i++) &#123;</span><br><span class="line">    <span class="comment">// æ ¹æ® section è§’æ ‡ä½ç½®ï¼Œåœ¨ Indirect Symbols é‡Œç›¸åº”ä½ç½®æ‰¾åˆ°ç›®æ ‡ç¬¦å·ä½ç½®</span></span><br><span class="line">    <span class="type">uint32_t</span> symtab_index = indirect_symbol_indices[i];</span><br><span class="line">    <span class="keyword">if</span> (symtab_index == INDIRECT_SYMBOL_ABS || symtab_index == INDIRECT_SYMBOL_LOCAL ||</span><br><span class="line">        symtab_index == (INDIRECT_SYMBOL_LOCAL   | INDIRECT_SYMBOL_ABS)) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ ¹æ®åœ¨ Indirect Symbols é‡Œæ‰¾åˆ°ç›®æ ‡ç¬¦å·ä½ç½®ï¼Œåœ¨ symtab ç¬¦å·è¡¨é‡ŒæŸ¥æ‰¾å­—ç¬¦ä¸²è¡¨åç§»ä½ç½®</span></span><br><span class="line">    <span class="comment">// æ³¨ï¼š</span></span><br><span class="line">    <span class="comment">// union &#123;</span></span><br><span class="line">    <span class="comment">//     uint32_t  n_strx; /* index into the string table */</span></span><br><span class="line">    <span class="comment">// &#125; n_un;</span></span><br><span class="line">    <span class="type">uint32_t</span> strtab_offset = symtab[symtab_index].n_un.n_strx;</span><br><span class="line">    <span class="comment">// å­—ç¬¦ä¸²è¡¨åŠ ä¸Šåç§»ä½ç½®å³å¯æ‰¾åˆ°ç¬¦å·åç§°</span></span><br><span class="line">    <span class="type">char</span> *symbol_name = strtab + strtab_offset;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rebindings_entry</span> *<span class="title">cur</span> =</span> rebindings;</span><br><span class="line">    <span class="comment">// éå† rebindings_entryï¼ŒåŒ¹é…å‡ºç›®æ ‡ç¬¦å·ï¼Œè¿›è¡Œç¬¦å·åœ°å€é‡ç»‘å®š</span></span><br><span class="line">    <span class="keyword">while</span> (cur) &#123;</span><br><span class="line">      <span class="comment">// éå†æ¯ä¸ª rebindings_entry äº†çš„ rebindings æ•°ç»„</span></span><br><span class="line">      <span class="keyword">for</span> (uint j = <span class="number">0</span>; j &lt; cur-&gt;rebindings_nel; j++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strlen</span>(symbol_name) &gt; <span class="number">1</span> &amp;&amp;</span><br><span class="line">            <span class="built_in">strcmp</span>(&amp;symbol_name[<span class="number">1</span>], cur-&gt;rebindings[j].name) == <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (cur-&gt;rebindings[j].replaced != <span class="literal">NULL</span> &amp;&amp;</span><br><span class="line">              indirect_symbol_bindings[i] != cur-&gt;rebindings[j].replacement) &#123;</span><br><span class="line">            <span class="comment">// å°†åŒ¹é…åˆ°çš„ç›®æ ‡ç¬¦å·åœ°å€èµ‹å€¼ç»™ replaced</span></span><br><span class="line">            *(cur-&gt;rebindings[j].replaced) = indirect_symbol_bindings[i];</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// åŒ¹é…åˆ°ç›®æ ‡ç¬¦å·ï¼Œè¿›è¡Œç¬¦å·åœ°å€é‡ç»‘å®š replacement</span></span><br><span class="line">          indirect_symbol_bindings[i] = cur-&gt;rebindings[j].replacement;</span><br><span class="line">          <span class="keyword">goto</span> symbol_loop;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      cur = cur-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">  symbol_loop:;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è‡³æ­¤ï¼Œfishhook çš„æºç ç¬”è®°å°±ç»“æŸäº†ã€‚</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/24858664">Mach-Oæ–‡ä»¶æ ¼å¼</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.cn/post/6897528762708000776">fishHookæºç åˆ†æ</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/b3dc9c429627">IOSä¹‹fishhookåŸç†æ¢ç©¶</a></li>
</ul>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2021/08/08/cocoapods-update-pod-sources/" rel="next" title="ä¿®å¤ pod install æ— æ³•æ­£ç¡®æ‹‰å– pod ä»£ç ">
                <i class="fa fa-chevron-left"></i> ä¿®å¤ pod install æ— æ³•æ­£ç¡®æ‹‰å– pod ä»£ç 
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2021/09/04/FBRetainCycleDetector/" rel="prev" title="FBRetainCycleDetector æºç ç¬”è®°">
                FBRetainCycleDetector æºç ç¬”è®° <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a target="_blank" rel="noopener" href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            æ–‡ç« ç›®å½•
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            ç«™ç‚¹æ¦‚è§ˆ
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.png"
                alt="" />
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%20%7C%7C%20archive">
              
                  <span class="site-state-item-count">52</span>
                  <span class="site-state-item-name">æ—¥å¿—</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">5</span>
                  <span class="site-state-item-name">åˆ†ç±»</span>
                </a>
              </div>
            

            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/gonghonglou" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://weibo.com/gonghonglou" target="_blank" title="Weibo">
                      
                        <i class="fa fa-fw fa-weibo"></i>Weibo</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://twitter.com/gonghonglou" target="_blank" title="Twitter">
                      
                        <i class="fa fa-fw fa-twitter"></i>Twitter</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8A%A8%E6%80%81%E5%BA%93%E7%AC%A6%E5%8F%B7%E5%9C%B0%E5%9D%80%E6%9F%A5%E6%89%BE%E4%B8%8E%E7%BB%91%E5%AE%9A"><span class="nav-number">1.</span> <span class="nav-text">åŠ¨æ€åº“ç¬¦å·åœ°å€æŸ¥æ‰¾ä¸ç»‘å®š</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#fishhook-%E4%BD%BF%E7%94%A8%E5%8F%8A%E9%AA%8C%E8%AF%81"><span class="nav-number">2.</span> <span class="nav-text">fishhook ä½¿ç”¨åŠéªŒè¯</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E5%90%88-MachoView-%E9%AA%8C%E8%AF%81"><span class="nav-number">2.1.</span> <span class="nav-text">é…åˆ MachoView éªŒè¯</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Mach-O-%E6%A0%BC%E5%BC%8F%E6%96%87%E4%BB%B6"><span class="nav-number">3.</span> <span class="nav-text">Mach-O æ ¼å¼æ–‡ä»¶</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#mach-header-64"><span class="nav-number">3.1.</span> <span class="nav-text">mach_header_64</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#load-command"><span class="nav-number">3.2.</span> <span class="nav-text">load_command</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#segment-command-64"><span class="nav-number">3.3.</span> <span class="nav-text">segment_command_64</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#section-64"><span class="nav-number">3.4.</span> <span class="nav-text">section_64</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#symtab-command"><span class="nav-number">3.5.</span> <span class="nav-text">symtab_command</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#dysymtab-command"><span class="nav-number">3.6.</span> <span class="nav-text">dysymtab_command</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#nlist-64"><span class="nav-number">3.7.</span> <span class="nav-text">nlist_64</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#fishhook-%E5%AE%98%E5%9B%BE%E6%B5%81%E7%A8%8B"><span class="nav-number">4.</span> <span class="nav-text">fishhook å®˜å›¾æµç¨‹</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#fishhook-%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB"><span class="nav-number">5.</span> <span class="nav-text">fishhook æºç è§£è¯»</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#struct-rebinding"><span class="nav-number">5.1.</span> <span class="nav-text">struct rebinding</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#struct-rebindings-entry"><span class="nav-number">5.2.</span> <span class="nav-text">struct rebindings_entry</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#rebind-symbols-image"><span class="nav-number">5.3.</span> <span class="nav-text">rebind_symbols_image</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#rebind-symbols"><span class="nav-number">5.4.</span> <span class="nav-text">rebind_symbols</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#prepend-rebindings"><span class="nav-number">5.5.</span> <span class="nav-text">prepend_rebindings</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#rebind-symbols-for-image"><span class="nav-number">5.6.</span> <span class="nav-text">_rebind_symbols_for_image</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#rebind-symbols-for-image-1"><span class="nav-number">5.7.</span> <span class="nav-text">rebind_symbols_for_image</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#perform-rebinding-with-section"><span class="nav-number">5.8.</span> <span class="nav-text">perform_rebinding_with_section</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Reference"><span class="nav-number">6.</span> <span class="nav-text">Reference</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ä¸ä½³æœŸ</span>

  
</div>


  <div class="powered-by">ç”± <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> å¼ºåŠ›é©±åŠ¨</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">ä¸»é¢˜ &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'http://gonghonglou.com/2021/08/21/fishhook/';
          this.page.identifier = '2021/08/21/fishhook/';
          this.page.title = 'fishhook æºç ç¬”è®°';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://gonghonglou.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  














  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
